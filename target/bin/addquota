#! /bin/bash

DATABASE=${DATABASE:-/tmp/docker-mailserver/dovecot-quotas.cf}

USER="$1"
shift
QUOTA="$@"

usage() {
	echo "Usage: addquota <user@domain> [<quota>]"
}

errex() {
	echo "$@" 1>&2
	exit 1
}

escape() {
	echo "${1//./\\.}"
}

[ -z "$USER" ] && { usage; errex "no username specified"; }
expr index "$USER" "@" >/dev/null || { usage; errex "username must include the domain"; }

# Protect config file with lock to avoid race conditions
touch $DATABASE
(
  flock -e 200

  grep -qi "^$(escape "$USER"):" $DATABASE 2>/dev/null &&
    errex "Quota for \"$USER\" already exists"

  if [ -z "$QUOTA" ]; then
    read -s "Enter quota: " QUOTA
    echo
    [ -z "$QUOTA" ] && errex "Quota must not be empty. Use 0 for unlimited quota"
  fi

  echo "$USER:$QUOTA" >> $DATABASE
) 200<$DATABASE
